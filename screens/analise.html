<!-- screens/analise.html -->
<div class="page" data-screen-title="An√°lises">
  <div class="dashboard-header">
    <p class="subtitle">Vis√£o das A√ß√µes em Base Dados</p>
  </div>

  <!-- TOOLBAR / PESQUISA E FILTROS -->
  <div class="card analysis-toolbar" style="margin-bottom: 12px">
    <div class="toolbar-row">
      <label>
        Pesquisa (Ticker / Nome)
        <input id="anlSearch" type="search" placeholder="ex.: AAPL, Apple..." />
      </label>
    </div>
    <div class="toolbar-grid">
      <label>
        Setor
        <select id="anlSetor">
          <option value="">Todos</option>
        </select>
      </label>
      <label>
        Mercado
        <select id="anlMercado">
          <option value="">Todos</option>
        </select>
      </label>
      <label>
        Periodicidade
        <select id="anlPeriodo">
          <option value="">Todas</option>
          <option>Mensal</option>
          <option>Trimestral</option>
          <option>Semestral</option>
          <option>Anual</option>
          <option>n/A</option>
        </select>
      </label>
    </div>
    <div style="margin-top: 0.6rem">
      <button class="btn outline" id="anlReset">Limpar filtros</button>
    </div>
  </div>

  <!-- GR√ÅFICOS -->
  <div class="portfolio-charts three-cols">
    <div class="card">
      <h3>Distribui√ß√£o por Setor</h3>
      <div class="chart-wrap"><canvas id="anlChartSetor"></canvas></div>
    </div>
    <div class="card">
      <h3>Distribui√ß√£o por Mercado</h3>
      <div class="chart-wrap"><canvas id="anlChartMercado"></canvas></div>
    </div>
    <div class="card">
      <h3>Top 5 por Yield</h3>
      <div class="chart-wrap"><canvas id="anlChartTopYield"></canvas></div>
    </div>
  </div>

  <!-- CALEND√ÅRIO DE DIVIDENDOS -->
  <div class="card" style="margin-top: 12px">
    <div class="card-content" style="display: block">
      <div class="dividend-header">
        <h3 style="margin: 0">Calend√°rio de Dividendos (12 meses)</h3>
        <div class="muted" style="font-size: 0.9rem">
          C√©lulas preenchidas indicam meses t√≠picos de pagamento; valor ‚âà
          <strong>pagamento m√©dio por a√ß√£o (24m)</strong>
        </div>
      </div>

      <div class="dividend-heatmap">
        <!-- Header com scroll horizontal sincronizado -->
        <div class="heatmap-header">
          <div class="cell sticky-col"></div>
          <div id="anlHeatmapHeaderScroll" class="months-scroll">
            <div class="months" id="anlHeatmapHeaderMonths">
              <div class="cell">Jan</div>
              <div class="cell">Fev</div>
              <div class="cell">Mar</div>
              <div class="cell">Abr</div>
              <div class="cell">Mai</div>
              <div class="cell">Jun</div>
              <div class="cell">Jul</div>
              <div class="cell">Ago</div>
              <div class="cell">Set</div>
              <div class="cell">Out</div>
              <div class="cell">Nov</div>
              <div class="cell">Dez</div>
            </div>
          </div>
        </div>

        <!-- Body com scroll (vertical + horizontal) -->
        <div id="anlHeatmapBody" class="heatmap-body"></div>
      </div>

      <div class="legend" style="margin-top: 6px">
        <span class="legend-item">
          <span class="legend-box weak"></span> estimado baixo
        </span>
        <span class="legend-item">
          <span class="legend-box med"></span> estimado m√©dio
        </span>
        <span class="legend-item">
          <span class="legend-box strong"></span> estimado alto
        </span>
      </div>
    </div>
  </div>

  <!-- TABELA -->
  <div class="card" style="margin-top: 12px">
    <div class="card-content" style="display: block">
      <!-- Sele√ß√£o + Simulador -->
      <div class="analysis-toolbar" style="padding: 0.6rem 1rem; border: 0; background: transparent">
        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap">
          <button class="btn outline" id="anlSimular">Usar no simulador</button>
          <button class="btn ghost" id="anlClearSel">Limpar sele√ß√£o</button>
          <span class="muted">Selecionados: <strong id="anlSelCount">0</strong></span>
        </div>
      </div>

      <div class="table-scroll">
        <table class="fine-table analysis-table" id="anlTable">
          <thead>
            <tr>
              <th class="sticky-col" style="width: 44px">
                <input type="checkbox" id="anlSelectAll" title="Selecionar todos os filtrados" />
              </th>
              <th data-sort="ticker" class="sortable sticky-col">Ticker</th>
              <th data-sort="nome" class="sortable">Nome</th>
              <th data-sort="setor" class="sortable">Setor</th>
              <th data-sort="mercado" class="sortable">Mercado</th>
              <th data-sort="yield" class="sortable">Yield</th>
              <th data-sort="yield24" class="sortable">Yield 24m</th>
              <th data-sort="divPer" class="sortable">Dividendo/pag.</th>
              <th data-sort="divAnual" class="sortable">Dividendo/ano</th>
              <th data-sort="pe" class="sortable">P/E</th>
              <th data-sort="delta50" class="sortable">Œî50d%</th>
              <th data-sort="delta200" class="sortable">Œî200d%</th>
              <th data-sort="g1w" class="sortable">1S</th>
              <th data-sort="g1m" class="sortable">1M</th>
              <th data-sort="g1y" class="sortable">1A</th>
              <th data-sort="periodicidade" class="sortable">Periodicidade</th>
              <th data-sort="mes" class="sortable">M√™s t√≠pico</th>
              <th data-sort="observacao" class="sortable">Notas</th>
            </tr>
          </thead>
          <tbody id="anlTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Simula√ß√£o -->
<div id="anlSimModal" class="modal hidden">
  <div class="modal-dialog">
    <div class="modal-header">
      <h3>Simular investimento (lucro m√°ximo)</h3>
      <button class="icon-btn" id="anlSimClose" title="Fechar">‚úñ</button>
    </div>

    <div class="modal-body">
      <div class="form-grid">
        <label>
          Investimento total (‚Ç¨)
          <input id="anlSimInvest" type="number" min="1" step="0.01" placeholder="Ex.: 1000" />
        </label>
        <label>
          Horizonte (anos)
          <input id="anlSimHoriz" type="number" min="1" step="1" value="1" />
        </label>
        <label>
          Per√≠odo de crescimento
          <select id="anlSimPeriodo">
            <option value="1s">1 semana</option>
            <option value="1m" selected>1 m√™s</option>
            <option value="1a">1 ano</option>
          </select>
        </label>

        <div class="sim-options">
          <label class="chk-inline">
            <input id="anlSimInvestirTotal" type="checkbox" checked />
            Usar investimento total (fra√ß√µes permitidas)
          </label>
          <label class="chk-inline">
            <input id="anlSimInteiros" type="checkbox" />
            Apenas a√ß√µes completas (sem fra√ß√µes)
          </label>
          <label class="chk-inline push-right">
            <input id="anlSimIncluiDiv" type="checkbox" checked />
            Incluir dividendos
          </label>
        </div>
      </div>

      <div class="actions-row sticky-actions">
        <button class="btn outline" id="anlSimCalcular">Calcular</button>
        <button class="btn" id="anlSimRelatorio">Ver Relat√≥rio</button>
      </div>

      <!-- DISTRIBUI√á√ÉO POR SETOR (tickers selecionados) -->
      <div id="anlSelSectorChartWrap" class="pie-wrap">
        <canvas id="anlSelSectorChart"></canvas>
      </div>

      <div id="anlSimResultado" style="margin-top: 10px"></div>
    </div>
  </div>
</div>

<!-- PREVIEW DO RELAT√ìRIO -->
<div id="anlReportModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="repTitle">
  <div class="modal-content" style="max-width:1100px;">
    <div class="modal-header">
      <h3 id="repTitle">Relat√≥rio Financeiro ‚Äî Pr√©-visualiza√ß√£o</h3>
      <button id="repClose" class="btn outline" title="Fechar">‚úï</button>
    </div>

    <!-- üîΩ TUDO DO RELAT√ìRIO FICA DENTRO DA .modal-body -->
    <div class="modal-body">
      <!-- KPIs -->
      <section class="rep-kpis">
        <div class="kpi">
          <div class="kpi-title">Valor Investido</div>
          <div id="repKpiInv" class="kpi-value">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Retorno Total</div>
          <div id="repKpiRet" class="kpi-value">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Dividendos (Anual / Horizonte)</div>
          <div id="repKpiDiv" class="kpi-value">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Valoriza√ß√£o Projetada</div>
          <div id="repKpiVal" class="kpi-value">‚Äî</div>
        </div>
      </section>

      <!-- GR√ÅFICOS (pequenos) -->
      <section class="rep-charts">
        <div class="chart-card">
          <h4>Distribui√ß√£o do Investimento por Ativo</h4>
          <canvas id="repChartInvestByTicker"></canvas>
        </div>
        <div class="chart-card">
          <h4>Distribui√ß√£o do Investimento por Setor</h4>
          <canvas id="repChartInvestBySector"></canvas>
        </div>
        <div class="chart-card">
          <h4>Lucro Estimado por Ativo</h4>
          <canvas id="repChartLucro"></canvas>
        </div>
        <div class="chart-card">
          <h4>Dividendos vs Valoriza√ß√£o (H)</h4>
          <canvas id="repChartDivVsVal"></canvas>
        </div>
        <div class="chart-card">
          <h4>Valor Investido por Ativo</h4>
          <canvas id="repChartInvestBars"></canvas>
        </div>
      </section>

      <!-- TABELA -->
      <section class="rep-table">
        <table id="repTable" class="fine-table" style="width:100%">
          <thead>
            <tr>
              <th>Ativo</th><th>Ticker</th>
              <th>Investido (‚Ç¨)</th><th>Div. Anuais (‚Ç¨)</th>
              <th>Div. Horizonte (‚Ç¨)</th><th>Valoriza√ß√£o (‚Ç¨)</th>
              <th>Lucro Estimado (‚Ç¨)</th><th>% Port.</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- INDICADORES-CHAVE -->
      <section class="rep-notes">
        <ul id="repKeyNotes" class="notes"></ul>
      </section>
    </div>

    <!-- üîΩ UM S√ì FOOTER (IDs √∫nicos) -->
    <div class="modal-footer">
      <button id="repExportPdf" class="btn">Exportar PDF</button>
      <button id="repCloseBottom">Fechar</button>
    </div>
  </div>
</div>



<!-- estilos -->
<style>
  .portfolio-charts.three-cols{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:980px){.portfolio-charts.three-cols{grid-template-columns:1fr}}
  .chart-wrap{height:260px}.chart-wrap canvas{width:100%!important;height:100%!important}

  .dividend-header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:6px}
  .legend{margin-top:6px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .legend-item{display:inline-flex;align-items:center;gap:6px}
  .legend-box{width:14px;height:14px;border-radius:4px;display:inline-block}
  .legend-box.weak{background:rgba(34,197,94,.18)}
  .legend-box.med{background:rgba(34,197,94,.38)}
  .legend-box.strong{background:rgba(34,197,94,.58)}

  .dividend-heatmap{border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden}
  .dividend-heatmap .cell{padding:8px 10px;border-right:1px solid var(--border,#e5e7eb);white-space:nowrap}
  .dividend-heatmap .heatmap-header{display:grid;grid-template-columns:220px 1fr;background:var(--muted-bg,rgba(0,0,0,.03));position:sticky;top:0;z-index:1}
  .dividend-heatmap .months{display:grid;grid-template-columns:repeat(12,minmax(72px,1fr))}
  .months-scroll{overflow:auto}
  .dividend-heatmap .heatmap-body{max-height:420px;overflow:auto}
  .dividend-heatmap .row{display:grid;grid-template-columns:220px 1fr;border-top:1px solid var(--border,#e5e7eb)}
  .dividend-heatmap .row .months{display:grid;grid-template-columns:repeat(12,minmax(72px,1fr))}
  .dividend-heatmap .sticky-col{position:sticky;left:0;background:var(--card,#fff);z-index:2;border-right:1px solid var(--border,#e5e7eb)}
  .dividend-heatmap .tt{position:relative}
  .dividend-heatmap .tt:hover::after{content:attr(data-tt);position:absolute;bottom:100%;left:0;transform:translateY(-4px);background:rgba(0,0,0,.85);color:#fff;font-size:12px;padding:6px 8px;border-radius:6px;white-space:nowrap}
  .pay-weak{background:rgba(34,197,94,.18)}
  .pay-med{background:rgba(34,197,94,.38)}
  .pay-strong{background:rgba(34,197,94,.58);color:#fff}

  .table-scroll{overflow:auto;max-height:62vh}
  #anlTable thead th{position:sticky;top:0;z-index:3;background:var(--card,#fff)}
  #anlTable thead th.sortable{cursor:pointer;user-select:none}
  #anlTable thead th.sorted-asc::after{content:" ‚Üë";opacity:.7}
  #anlTable thead th.sorted-desc::after{content:" ‚Üì";opacity:.7}
  #anlTable .sticky-col{position:sticky;left:0;z-index:2;background:var(--card,#fff)}
  #anlTable th.sticky-col:nth-child(2),#anlTable td.sticky-col:nth-child(2){left:44px}

  .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:.75rem}
  .badge.ok{background:#e6f7ee;color:#106f3a}
  .badge.warn{background:#fff3cd;color:#7c5b00}
  .badge.danger{background:#fde2e2;color:#8a1f1f}
  .badge.muted{background:#f2f2f2;color:#666}
  .badge.up{background:#e6f7ee;color:#106f3a}
  .badge.down{background:#fde2e2;color:#8a1f1f}
  .up{color:#106f3a}.down{color:#8a1f1f}

  .modal.hidden{display:none}
  .modal{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center}
  .modal-dialog{width:min(820px,92vw);max-height:90vh;display:flex;flex-direction:column;border-radius:14px;overflow:hidden;background:var(--card,#fff);color:var(--card-foreground,#111);border:1px solid var(--border,#e5e7eb);box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border,#e5e7eb);background:var(--background,#fff);position:sticky;top:0;z-index:2}
  .modal-body{padding:14px 16px;overflow:auto}
  .icon-btn{background:transparent;border:0;font-size:18px;cursor:pointer;color:inherit}
  #anlSimModal .form-grid input,#anlSimModal .form-grid select{padding:.6rem .7rem;border-radius:10px;border:1px solid var(--border,#e5e7eb);background:var(--card,#fff);color:var(--card-foreground,#111)}
  .sim-options{display:flex;gap:18px;align-items:center;flex-wrap:wrap;grid-column:1 / -1;margin-top:.4rem}
  .chk-inline{display:flex;align-items:center;gap:.5rem}
  .push-right{margin-left:auto}
  [data-theme="dark"] .modal-dialog{background:#111;color:#fff;border-color:rgba(255,255,255,.08)}
  [data-theme="dark"] .modal-header{background:#111;border-color:rgba(255,255,255,.08)}
  [data-theme="dark"] #anlSimModal .form-grid input,[data-theme="dark"] #anlSimModal .form-grid select{background:#1a1a1a;color:#eee;border-color:rgba(255,255,255,.12)}
  .tabela-scroll-wrapper{overflow:auto}
  .actions-row.sticky-actions{display:flex;gap:.6rem;justify-content:flex-end;position:sticky;bottom:0;background:var(--card,#fff);padding-top:8px}

  /* pizza modal */
  .pie-wrap{width:100%;max-width:420px;margin:10px auto;padding:10px}
  .pie-wrap canvas{width:100%!important;height:auto!important;max-height:300px}
  @media (max-width:480px){.dividend-heatmap .months{grid-template-columns:repeat(12,minmax(84px,1fr))}.dividend-heatmap .row .months{grid-template-columns:repeat(12,minmax(84px,1fr))}.pie-wrap{max-width:360px}.pie-wrap canvas{max-height:260px}}
</style>

<script type="module" src="./analise.js"></script>